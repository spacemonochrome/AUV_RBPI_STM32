import time
import os
import threading
import serial
import smbus
import subprocess

dogrulamabyti = 95
durmasarti = False
TxSpwm = [125,125,125,125]
Spwm = [125,125,125,125]
TxMotorverisi = [125,125,125,125,125,125,125,125]
MotorDeger = [125,125,125,125,125,125,125,125]

TxData = [None]
RxData = [None]

telemetri = [None,None,None, None,None,None, None,None,None, None,None,None]
#Ax, Ay, Az, Gx, Gy, Gz, Px, Py, Pz, Cpi, Cstm, Cmpu


bus = smbus.SMBus(1)

ser = serial.Serial(
        port='/dev/ttyS0',
        baudrate = 115200,
        parity=serial.PARITY_NONE,
        stopbits=serial.STOPBITS_ONE,
        bytesize=serial.EIGHTBITS,
        timeout=100
)

def MotorDegerUpdate():
        global durmasarti
        global MotorDeger
        global TxMotorverisi
        global TxSpwm
        global Spwm
        while durmasarti:
                for i in range(0,len(MotorDeger)):
                        if MotorDeger[i] > TxMotorverisi[i]:
                                TxMotorverisi[i] = TxMotorverisi[i] + 1
                        elif MotorDeger[i] == TxMotorverisi[i]:
                                pass
                        elif MotorDeger[i] < TxMotorverisi[i]:
                                TxMotorverisi[i] = TxMotorverisi[i] - 1
                for i in range(0,len(Spwm)):
                        if Spwm[i] > TxSpwm[i]:
                                TxSpwm[i] = TxSpwm[i] + 1
                        elif Spwm[i] == TxSpwm[i]:
                                pass
                        elif Spwm[i] < TxSpwm[i]:
                                TxSpwm[i] = TxSpwm[i] - 1
                time.sleep(0.005)

def TelemetriKaydet():
        global durmasarti
        while durmasarti:
                time.sleep(0.005)
                with open("telemetri_verisi.txt", "w") as dosya:
                        dosya.write(", ".join(map(str, telemetri)))
                        

def sicaklik_oku_vcgencmd():
        global durmasarti, telemetri
        while durmasarti:
                try:
                        sonuc = subprocess.check_output(["vcgencmd", "measure_temp"]).decode("utf-8")
                        telemetri[9] = float(sonuc.split("=")[1].split("'")[0])
                        time.sleep(0.1)
                except FileNotFoundError:
                        print("vcgencmd bulunamadi")

def ikarece():
        global durmasarti
        while durmasarti:
                pass

def EkranaYaz():
        global TxData
        global RxData
        global durmasarti
        while durmasarti:
                time.sleep(0.1)
                os.system("clear")
                print("Giden Veri " + str(TxData) + " \n " + "Gelen veri " + str(RxData) + " \n")

def UartWrite():
        global TxData
        global durmasarti
        global dogrulamabyti
        global TxSpwm
        while durmasarti:
                TxData = [dogrulamabyti] + TxMotorverisi + [dogrulamabyti] + TxSpwm + [dogrulamabyti]
                ser.write(bytearray(TxData))

def UartRead():
        global RxData
        global durmasarti
        while durmasarti:
                yeniData = ser.read(32)
                #doÄŸruluk bitleri kontrol edilecek ondan sonra aktarma olucak
                # yeniData = RxData

def MotorValueUpdate():
        global durmasarti
        global MotorDeger
        global TxSpwm
        global Spwm
        MotorDeger = [125,125,125,125,125,125,125,125]
        while True:
                sayilar = [int(veri) for veri in open("TestMotorSayisalRT.txt", "r").read().split(',') if veri.isdigit()]
                Spwm = sayilar[-4:]
                MotorDeger = sayilar[:8]
                time.sleep(0.005)
        MotorDeger = [125,125,125,125,125,125,125,125]
        time.sleep(1)

        print("\n ---------- motorlar durdu ---------- \n")
        durmasarti = False

if __name__ == '__main__':
        durmasarti = True
        os.chdir("Belirsiz_Adres")
        t1 = threading.Thread(target = MotorValueUpdate)
        t2 = threading.Thread(target = MotorDegerUpdate)
        t3 = threading.Thread(target = EkranaYaz)
        t4 = threading.Thread(target = TelemetriKaydet)
        t5 = threading.Thread(target = sicaklik_oku_vcgencmd)

        t6 = threading.Thread(target = UartWrite)
        t7 = threading.Thread(target = UartRead)
        t8 = threading.Thread(target = ikarece)

        t1.start()
        t2.start()
        t3.start()
        t4.start()
        t5.start()
        t6.start()
        t7.start()
        t8.start()

        t1.join()
        t2.join()
        t3.join()
        t4.join()
        t5.join()
        t6.join()
        t7.join()
        t8.join()
        print("durdu")
        